#!/usr/bin/env bash

set -e

# Definitions
REPO_DIR="$HOME/GitHub/NikoboiNFTB/Guitar-Pro-On-Linux"
PREFIX="$HOME/Applications/Windows/Guitar-Pro-8"
DESKTOP="$HOME/Desktop"
APPLICATIONS="$HOME/.local/share/applications"

# Keep the installer
mv "$PREFIX/guitar-pro-8-setup.exe" "$REPO_DIR/guitar-pro-8-setup.exe"
rm -rf "$PREFIX"
mkdir -p "$PREFIX"
mv "$REPO_DIR/guitar-pro-8-setup.exe" "$PREFIX/guitar-pro-8-setup.exe"

# Expand $HOME in .desktop file to absolute path
DESKTOP_FILE="$REPO_DIR/guitarpro.desktop"
APPLICATIONS_FILE="$APPLICATIONS/guitarpro.desktop"
REAL_HOME="$HOME"

# Ensure $HOME exists
if [ -z "$HOME" ]; then
    echo "HOME variable not set!"
    exit 1
fi


# Replace $HOME with your actual home in the desktop file
sed -i "s|Icon=\$HOME|Icon=$REAL_HOME|g" "$DESKTOP_FILE"
sed -i "s|Exec=\$HOME|Exec=$REAL_HOME|g" "$DESKTOP_FILE"

# Replace broken default Wine shortcuts with working ones
rm -rf "$HOME/.local/share/applications/wine/Programs/Arobas Music"
rm -f "$HOME/.local/share/applications/Guitar Pro 8.desktop"
rm -f "$DESKTOP/Guitar Pro 8.desktop"
rm -f "$DESKTOP/guitarpro.desktop"
rm -f "$APPLICATIONS/Guitar Pro 8.desktop"
rm -f "$APPLICATIONS/guitarpro.desktop"
cp "$REPO_DIR/guitarpro.desktop" "$HOME/.local/share/applications/guitarpro.desktop"
chmod +x "$HOME/.local/share/applications/guitarpro.desktop"


# Copy
echo "Updating startup scripts and icon..."
cp -f "$REPO_DIR/startup" "$PREFIX/"
chmod +x "$PREFIX/startup"
cp -f "$REPO_DIR/favicon.ico" "$PREFIX/"
cp -f "$REPO_DIR/guitarpro.desktop" "$DESKTOP/guitarpro.desktop"
chmod +x "$DESKTOP/guitarpro.desktop"



# Download Guitar Pro 8 installer
cd "$PREFIX"
if [ ! -f guitar-pro-8-setup.exe ]; then
    echo "Downloading Guitar Pro 8..."
    wget -O guitar-pro-8-setup.exe https://download-fr-3.guitar-pro.com/gp8/stable/guitar-pro-8-setup.exe
fi

# Prepare Wine prefix
if [ ! -d "$PREFIX/drive_c" ]; then
    echo "Setting up Wine prefix..."
    WINEARCH=win64 WINEPREFIX="$PREFIX" wineboot --init
    WINEARCH=win64 WINEPREFIX="$PREFIX" winetricks -q win7 corefonts
fi

# Install Guitar Pro 8 but check if GP8 is already installed
if [ ! -f "$PREFIX/drive_c/Program Files/Arobas Music/Guitar Pro 8/GuitarPro.exe" ]; then
    echo "Guitar Pro 8 not found. Installing..."
    WINEARCH=win64 WINEPREFIX="$PREFIX" wine "$PREFIX/guitar-pro-8-setup.exe"
else
    echo "Guitar Pro 8 is already installed. Skipping installer."
fi

echo "Guitar Pro 8 setup finished!"

# Replace your actual home with $HOME in the desktop file
sed -i "s|Icon=$REAL_HOME|Icon=\$HOME|g" "$DESKTOP_FILE"
sed -i "s|Exec=$REAL_HOME|Exec=\$HOME|g" "$DESKTOP_FILE"
