#!/usr/bin/env bash

set -euo pipefail

# Ensure $HOME exists
if [ -z "$HOME" ]; then
    echo "❌ HOME variable not set!"
    exit 1
fi

# Definitions
REPO_DIR="$HOME/GitHub/NikoboiNFTB/Guitar-Pro-On-Linux"
PREFIX="$HOME/Applications/Windows/Guitar-Pro-8"

DESKTOP_DIR="$HOME/Desktop"
APPLICATIONS_DIR="$HOME/.local/share/applications"

DESKTOP_FILE_REPO="$REPO_DIR/guitarpro.desktop"
DESKTOP_FILE_DESKTOP="$HOME/Desktop"
DESKTOP_FILE_APPLICATIONS="$APPLICATIONS_DIR/guitarpro.desktop"

INSTALLER_NAME="guitar-pro-8-setup.exe"
INSTALLER_REPO="$REPO_DIR/$INSTALLER_NAME"
INSTALLER_PREFIX="$PREFIX/$INSTALLER_NAME"

GP8_EXE="$PREFIX/drive_c/Program Files/Arobas Music/Guitar Pro 8/GuitarPro.exe"

# Preserve installer and nuke prefix

echo "ℹ️  Preserving installer (if present) and wiping Wine prefix..."

if [ -f "$INSTALLER_PREFIX" ]; then
    mv -f "$INSTALLER_PREFIX" "$INSTALLER_REPO"
fi

rm -rf "$PREFIX"
mkdir -p "$PREFIX"

if [ -f "$INSTALLER_REPO" ]; then
    mv -f "$INSTALLER_REPO" "$INSTALLER_PREFIX"
fi

# Prepare and install custom desktop entry

echo "ℹ️  Installing custom desktop entry..."

sed -i "s|Icon=\$HOME|Icon=$HOME|g" "$DESKTOP_FILE_REPO"
sed -i "s|Exec=\$HOME|Exec=$HOME|g" "$DESKTOP_FILE_REPO"

cp -f "$DESKTOP_FILE_REPO" "$DESKTOP_FILE_APPLICATIONS"
chmod +x "$DESKTOP_FILE_APPLICATIONS"

cp -f "$DESKTOP_FILE_REPO" "$DESKTOP_FILE_DESKTOP"
chmod +x "$DESKTOP_FILE_DESKTOP"

sed -i "s|Icon=$HOME|Icon=\$HOME|g" "$DESKTOP_FILE_REPO"
sed -i "s|Exec=$HOME|Exec=\$HOME|g" "$DESKTOP_FILE_REPO"

# Copy startup scripts and icon

echo "ℹ️  Updating startup scripts and icon..."

cp -f "$REPO_DIR/startup" "$PREFIX/startup"
chmod +x "$PREFIX/startup"
cp -f "$REPO_DIR/reset" "$PREFIX/reset"
chmod +x "$PREFIX/reset"
cp -f "$REPO_DIR/reset-and-startup" "$PREFIX/reset-and-startup"
chmod +x "$PREFIX/reset-and-startup"

cp -f "$REPO_DIR/icons/Guitar_Pro_8_icon.png" "$PREFIX/"

# Download installer if missing

cd "$PREFIX"

if [ ! -f "$INSTALLER_NAME" ]; then
    echo "ℹ️  Downloading Guitar Pro 8 installer..."
    wget -O "$INSTALLER_NAME" \
        https://download-fr-3.guitar-pro.com/gp8/stable/guitar-pro-8-setup.exe
fi

# Prepare Wine prefix

if [ ! -d "$PREFIX/drive_c" ]; then
    echo "ℹ️  Initializing Wine prefix..."
    WINEARCH=win64 WINEPREFIX="$PREFIX" wineboot --init
    WINEARCH=win64 WINEPREFIX="$PREFIX" winetricks -q win7 corefonts
fi

# Install Guitar Pro 8

if [ ! -f "$GP8_EXE" ]; then
    echo "ℹ️  Installing Guitar Pro 8..."
    WINEARCH=win64 WINEPREFIX="$PREFIX" wine "$INSTALLER_PREFIX"
else
    echo "ℹ️  Guitar Pro 8 already installed. Skipping installer."
fi

echo "✅  Guitar Pro 8 setup finished."

# Remove broken Wine shortcuts
echo "ℹ️  Removing broken Wine desktop entries..."
rm -f "$DESKTOP_DIR/Guitar Pro 8.desktop" "$APPLICATIONS_DIR/Guitar Pro 8.desktop"
rm -rf "$APPLICATIONS_DIR/wine/Programs/Arobas Music"
